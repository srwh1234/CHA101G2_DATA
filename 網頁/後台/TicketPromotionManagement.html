<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>TirpLight後台</title>

    <!-- 自訂字型 -->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="botcss/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link
          href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
          rel="stylesheet">
    <script src="js/jquery-3.7.0.min.js"></script>
    <script src="js/login.js"></script>
    <!-- 自訂樣式 -->
    <link href="css/TripLight.min.css" rel="stylesheet">
    <!-- 使用Bootstrap-table -->
    <link href="css/bootstrap-table.min.css" rel="stylesheet">



    <style>
        /* 文字灰色 */
        .my-text-lightgray {
            color: gray;
            font-weight: bold;
        }

        /* 避免表格被過度壓縮 */
        .my-th-width {
            min-width: 12rem;
        }

        /* 避免表格被過度壓縮 小按鈕*/
        .my-th-width-sm {
            min-width: 6rem;
        }
    </style>
</head>

<body id="page-top" style="overflow-y: scroll;">
    <!-- 頁面包裹區域 -->
    <div id="wrapper">

        <!-- 側邊欄 -->
        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
            <!-- 側邊欄 - 品牌 -->
            <a class="sidebar-brand d-flex align-items-center justify-content-center" href="index.html">
                <img src="img/icon.png" alt="Icon" class="sidebar-brand-icon rotate-n-15"
                     style="width: 30px; height: 30px;">
                <div class="sidebar-brand-text mx-3">後台</div>
            </a>

            <!-- <div class="text-center d-none d-md-inline">
                <button class="rounded-circle border-0" id="sidebarToggle"></button>
            </div> -->

            <!-- 導覽項目 -  -->
            <li class="nav-item active">
                <a class="nav-link" href="https://triplight.netlify.app/">
                    <span>TirpLight</span></a>
            </li>
            <!-- 導覽項目 - 頁面折疊選單 -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseTwo"
                   aria-expanded="true" aria-controls="collapseTwo">
                    <span>員工管理</span>
                </a>
                <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="EmployeeQuety.html">查詢資料</a>
                        <a class="collapse-item" href="EmployeeRevise.html">新增資料</a>
                    </div>
                </div>
            </li>

            <!-- 導覽項目 - 公用程式折疊選單 -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseUtilities"
                   aria-expanded="true" aria-controls="collapseUtilities">
                    <span>會員管理</span>
                </a>
                <div id="collapseUtilities" class="collapse" aria-labelledby="headingUtilities"
                     data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="MemberQuety.html">查詢資料</a>
                        <a class="collapse-item" href="MemberRevise.html">修改資料</a>
                    </div>
                </div>
            </li>


            <!-- 功能頁面 -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapsePages"
                   aria-expanded="true" aria-controls="collapsePages">
                    <span>廠商管理</span>
                </a>
                <div id="collapsePages" class="collapse" aria-labelledby="headingPages" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="FirmInert.html">廠商資料</a>
                        <a class="collapse-item" href="FirmRevise.html">行程管理</a>
                        <a class="collapse-item" href="FirmReport.html">檢舉廠商</a>
                    </div>
                </div>
            </li>

            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseTickets"
                   aria-expanded="true" aria-controls="collapseTickets">
                    <span>票卷管理</span>
                </a>
                <div id="collapseTickets" class="collapse" aria-labelledby="headingTickets"
                     data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="TicketManagement.html">票卷資料管理</a>
                        <a class="collapse-item" href="TicketOrderManagement.html">票卷訂單管理</a>
                        <a class="collapse-item" href="TicketPromotionManagement.html">票卷促銷管理</a>
                        <a class="collapse-item" href="TicketSalesAnalysis.html">銷售分析</a>
                    </div>
                </div>
            </li>

            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseWebManagement"
                   aria-expanded="true" aria-controls="collapseWebManagement">
                    <span>網頁管理</span>
                </a>
                <div id="collapseWebManagement" class="collapse" aria-labelledby="headingWebManagement"
                     data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="TravelArticles.html">文章管理</a>
                        <a class="collapse-item" href="ReportAriocles.html">檢舉管理</a>
                    </div>
                </div>
            </li>


            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseCustomerService"
                   aria-expanded="true" aria-controls="collapseCustomerService">
                    <span>客服中心</span>
                </a>
                <div id="collapseCustomerService" class="collapse" aria-labelledby="headingCustomerService"
                     data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="QuestionFormManagement.html">問題表單管理</a>
                        <a class="collapse-item" href="CustomerServiceChatManagement.html">客服聊天管理</a>
                    </div>
                </div>
            </li>


            <!-- 側邊欄切換器（側邊欄） -->
            <!-- <div class="text-center d-none d-md-inline">
                <button class="rounded-circle border-0" id="sidebarToggle"></button>
            </div> -->
        </ul>
        <!-- 側邊導覽列結束 -->


        <!-- 內容包裹區域 -->
        <div id="content-wrapper" class="d-flex flex-column">

            <!-- 主要內容 -->
            <div id="content">

                <!-- 上導覽列 -->
                <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">

                    <!-- 側邊欄開關按鈕 -->
                    <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                        <i class="fa fa-bars"></i>
                    </button>


                    <!-- 上導覽列導覽選單 -->
                    <ul class="navbar-nav ml-auto">

                        <li class="nav-item dropdown no-arrow">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                               data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="mr-2 d-none d-lg-inline text-gray-600 small">超級管理員</span>
                                <i class="fas fa-user-circle fa-lg"></i>
                            </a>
                            <!-- 下拉選單 - 使用者資訊 -->
                            <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                                 aria-labelledby="userDropdown">
                                <a class="dropdown-item" href="#" id="logoutLink">
                                    登出
                                </a>
                            </div>
                        </li>
                    </ul>
                </nav>

                <!-- TODO: -->
                <div class="container">
                    <div class="row">

                        <div class="table-responsive p-3" id="promotionContainer">
                            <table class="table"
                                   data-toggle="table"
                                   data-sortable="true"
                                   data-sort-class="table-active"
                                   data-search="true"
                                   data-search-align="left">

                                <thead>
                                    <tr>
                                        <th class="my-th-width-sm" data-field="index" data-sortable="true">#</th>
                                        <th class="my-th-width" data-field="promotionTitle" data-sortable="true">促銷名稱</th>
                                        <th class="my-th-width" data-field="startDate" data-sortable="true">開始日期</th>
                                        <th class="my-th-width" data-field="endDate" data-sortable="true">結束日期</th>

                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 內容給JS填 -->
                                </tbody>
                            </table>
                        </div>
                        <div class="col-12 text-end">
                            <button type="button" class="btn btn-primary m-3" id="addPromotionBtn">
                                新增促銷
                            </button>
                        </div>
                        <!-- 稱高度用的 -->
                        <div style="height:30vh"></div>


                    </div>

                </div>



                <div class="container-fluid">

                    <div class="container d-none" id="detailContainer">
                        <div class="row p-3">
                            <div class="h3 my-5">
                                促銷明細<span class="text-muted mx-2">#<span id="promotionId">0000</span></span>
                            </div>

                            <div class="my-border-radius">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th class="my-th-width-sm">票券編號</th>
                                                <th class="my-th-width-sm">票券名稱</th>
                                                <th class="my-th-width-sm">原價</th>
                                                <th class="my-th-width-sm">促銷價</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- 內容給JS填 -->
                                        </tbody>
                                    </table>
                                </div>

                            </div>
                        </div>
                    </div>



                    <!-- 稱高度用的 -->
                    <div style="height:30vh"></div>
                </div>



                <!-- 新增優惠券的燈箱 -->
                <div class="modal fade" id="addPromotionModal" data-bs-backdrop="static" aria-hidden="true">
                    <div class="modal-dialog  modal-lg  modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">新增促銷</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="form-floating m-3">
                                            <input type="date" class="form-control" id="addPromotionStartDate" placeholder=".">
                                            <label class="my-text-lightgray" for="addPromotionStartDate">開始日期</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-floating m-3">
                                            <input type="date" class="form-control" id="addPromotionExpiryDate" placeholder=".">
                                            <label class="my-text-lightgray" for="addPromotionExpiryDate">到期日期</label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-floating m-3">
                                            <input type="text" class="form-control" id="addPromotionName" placeholder=".">
                                            <label class="my-text-lightgray" for="addPromotionName">名稱</label>
                                        </div>
                                        <div class="m-3">
                                            <select class="form-select" id="ticketSelect">
                                                <option value="1">qq</option>
                                                <option value="1">qqa</option>
                                                <option value="1">qqs</option>
                                                <option value="1">qqd</option>
                                            </select>
                                        </div>
                                    </div>



                                    <div class="col-12" id="selectContainer">
                                        <div class="table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th class="my-th-width-sm">票券編號</th>
                                                        <th class="my-th-width">票券名稱</th>
                                                        <th class="my-th-width-sm">原價</th>
                                                        <th class="my-th-width-sm">促銷價</th>
                                                        <th class="my-th-width-sm"></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- 內容給JS填 -->
                                                </tbody>
                                            </table>
                                        </div>

                                    </div>
                                </div>
                                <div class="m-3 d-flex justify-content-end">
                                    <button class="btn btn-primary" id="addPromotionSubmit">確定</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Bootstrap 核心 JavaScript -->
                <script src="vendor/jquery/jquery.min.js"></script>
                <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

                <!-- 核心插件 JavaScript -->
                <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

                <!-- 自訂腳本，適用於所有頁面 -->
                <script src="js/TripLight-2.min.js"></script>

                <!-- 頁面級別的插件 -->
                <script src="vendor/chart.js/Chart.min.js"></script>

                <!-- 頁面級別的自訂腳本 -->
                <script src="js/demo/chart-area-demo.js"></script>
                <script src="js/demo/chart-pie-demo.js"></script>
                <!-- 使用BootStrap-->

                <script src="vendor/bootstrap/js/bootstrap.bundle-5.2.3.js"></script>
                <script src="vendor/sweetalert/sweetalert.js"></script>
                <script src="js/bootstrap-table.min.js"></script>
                <script src="js/ticket_login_check.js"></script>

                <!-- TODO: -->
                <script>
                    let currentIndex = 0;
                    let resultData;

                    //
                    let selecterData = [];
                    let tableData = [];
                    $(function () {
                        fetch_data();


                        //確認送出的按鈕
                        $('#addPromotionSubmit').on('click', function () {
                            const post = {
                                promotionId: null,
                                promotionTitle: $('#addPromotionName').val(),
                                startDate: $('#addPromotionStartDate').val(),
                                endDate: $('#addPromotionExpiryDate').val(),
                                promotionDetails: [
                                    {
                                        key: {
                                            promotionId: 0,
                                            ticketId: 1,
                                        },

                                        promotionPrice: 1,
                                    },
                                ]
                            }
                            if (!post.promotionTitle) {
                                Swal.fire({ icon: 'error', title: '促銷名稱未輸入' });
                                return false;
                            }

                            if (!post.endDate) {
                                Swal.fire({ icon: 'error', title: '促銷到期日未輸入' });
                                return false;
                            }
                            if (!isDateAfterNow(post.endDate)) {
                                Swal.fire({ icon: 'error', title: '促銷到期日已經過期' });
                                return false;
                            }

                            if (!post.startDate) {
                                Swal.fire({ icon: 'error', title: '促銷開始日未輸入' });
                                return false;
                            }

                            if (isDateAfterTarget(post.startDate, post.endDate)) {
                                Swal.fire({ icon: 'error', title: '日期輸入錯誤' });
                                return false;
                            }

                            if(!post){

                            }

                            fetch(`${getDomainName()}/promotions`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(post),
                            })
                                .then(response => response.json())
                                .then(data => console.log(data))
                                .catch(error => console.log(error))
                                .finally(() => {

                                });

                            console.log(post)
                        });
                        // 促銷列表物件的取消
                        $(document).on('click', '.my-btn-cancel', function () {
                            const ticketId = $(this).closest('tr').find('td').first().text();
                            const data = tableData.find(e => e.ticketId == ticketId);

                            if (!data) {
                                return;
                            }
                            //從table移除
                            tableData = tableData.filter(e => e.ticketId != ticketId);
                            render_table();

                            //放回select
                            selecterData.push(data);
                            render_select();
                        });

                        //下拉選單事件
                        $('#ticketSelect').on('change', function () {
                            const ticketId = $(this).val();
                            const data = selecterData.find(e => e.ticketId == ticketId);

                            if (!data) {
                                return;
                            }
                            //從select移除
                            selecterData = selecterData.filter(e => e.ticketId != ticketId);
                            render_select();

                            //放到table
                            tableData.push(data);
                            render_table();
                        });

                        // 新增促銷
                        $('#addPromotionBtn').on('click', function () {
                            fetch(`${getDomainName()}/promotetickets`)
                                .then(response => response.json())
                                .then(data => selecterData = data)
                                .catch(error => console.log(error))
                                .finally(() => {
                                    render_select();
                                    $('#addPromotionModal').modal('show');
                                }
                                );
                        });




                        // 點選列的事件
                        $(document).on('click', '#promotionContainer tbody tr', function () {
                            currentIndex = $(this).find('td').first().text();

                            $('#promotionId').text(currentIndex);
                            const promotion = resultData._embedded.promotions[currentIndex];

                            $('#detailContainer').removeClass('d-none');
                            $('#detailContainer table tbody').html('');
                            for (let detail of promotion.promotionDetails) {
                                const ticket = detail.ticket;
                                const src = ticket._links.ticketType.href;
                                const ticketId = src.substring(src.lastIndexOf('/') + 1);

                                $('#detailContainer table tbody').append(`
                                    <tr>
                                        <td>${ticketId}</td>
                                        <td>${ticket.name}</td>
                                        <td>${ticket.price}</td>
                                        <td>${detail.promotionPrice}</td>
                                    </tr>
                                `);
                            }
                        });
                    })

                    //----------------------------------fetch
                    function fetch_data() {
                        fetch(`${getDomainName()}/promotions`)
                            .then(response => response.json())
                            .then(data => {
                                //給一個索引
                                let index = 0;
                                for (let promotion of data._embedded.promotions) {
                                    promotion['index'] = index++;
                                }
                                resultData = data;
                                $('#promotionContainer table').bootstrapTable('load', data._embedded.promotions);
                            })
                            .catch(error => console.log(error))
                    }

                    //--------------------------------------render

                    /**
                     * 渲染下拉式選單
                    */
                    function render_select() {
                        $('#ticketSelect').html('<option value="0" disabled>未選擇</option>');
                        for (let t of selecterData.sort((a, b) => a.ticketId - b.ticketId)) {
                            $('#ticketSelect').append(`
                               <option value="${t.ticketId}">${t.name}</option>
                            `);
                        }
                        $('#ticketSelect').val(0);
                    }

                    /**
                     * 渲染表格
                    */
                    function render_table() {
                        $('#selectContainer table tbody').html('');
                        for (let t of tableData.sort((a, b) => a.ticketId - b.ticketId)) {
                            $('#selectContainer table tbody').append(`
                                <tr>
                                    <td>${t.ticketId}</td>
                                    <td>${t.name}</td>
                                    <td>${t.price}</td>
                                    <td>
                                        <input class="form-control" type="number" min="1">
                                    </td>
                                    <td>                                        
                                        <button class="btn btn-danger my-btn-cancel">取消</button>                                        
                                    </td>
                                 </tr>
                            `);
                        }
                    }

                    //TODO: ------------------------------------------//好用的函式

                    //輸入的日期字串(yyyy-mm-dd) 是否在目前日期以後
                    function isDateAfterNow(dateString) {
                        if (!dateString) {
                            return false;
                        }
                        const dateParts = dateString.split('-');
                        const year = parseInt(dateParts[0]);
                        const month = parseInt(dateParts[1]) - 1; // 月份從0開始
                        const day = parseInt(dateParts[2]);
                        const inputDate = new Date(year, month, day);
                        return inputDate.getTime() > new Date().getTime();
                    }

                    function isDateAfterTarget(dateString, dateString2) {
                        if (!dateString || !dateString2) {
                            return false;
                        }

                        const dateParts = dateString.split('-');
                        const year = parseInt(dateParts[0]);
                        const month = parseInt(dateParts[1]) - 1; // 月份從0開始
                        const day = parseInt(dateParts[2]);
                        const inputDate = new Date(year, month, day);
                        //---------
                        const dateParts2 = dateString2.split('-');
                        const year2 = parseInt(dateParts2[0]);
                        const month2 = parseInt(dateParts2[1]) - 1; // 月份從0開始
                        const day2 = parseInt(dateParts2[2]);
                        const inputDate2 = new Date(year2, month2, day2);

                        return inputDate.getTime() > inputDate2.getTime();
                    }
                    // const t = {
                    //     "_embedded": {
                    //         "promotions":
                    //             [
                    //                 {
                    //                     "promotionTitle": "開學促銷",
                    //                     "startDate": "2023-04-01",
                    //                     "endDate": "2023-12-31",
                    //                     "promotionDetails": [
                    //                         {
                    //                             "promotionPrice": 499,
                    //                             "_links": {
                    //                                 "ticket": {
                    //                                     "href": "http://localhost:8080/tickets/1"
                    //                                 }
                    //                             }
                    //                         },
                    //                         {
                    //                             "promotionPrice": 99,
                    //                             "_links": {
                    //                                 "ticket": {
                    //                                     "href": "http://localhost:8080/tickets/2"
                    //                                 }
                    //                             }
                    //                         },
                    //                         {
                    //                             "promotionPrice": 199,
                    //                             "_links": {
                    //                                 "ticket": {
                    //                                     "href": "http://localhost:8080/tickets/3"
                    //                                 }
                    //                             }
                    //                         }
                    //                     ],
                    //                     "_links": {
                    //                         "self": {
                    //                             "href": "http://localhost:8080/promotions/1"
                    //                         },
                    //                         "promotion": {
                    //                             "href": "http://localhost:8080/promotions/1"
                    //                         }
                    //                     }
                    //                 },
                    //                 {
                    //                     "promotionTitle": "鬼月促銷",
                    //                     "startDate": "2023-07-01",
                    //                     "endDate": "2023-09-30",
                    //                     "promotionDetails": [{
                    //                         "promotionPrice": 199,
                    //                         "_links": {
                    //                             "ticket": {
                    //                                 "href": "http://localhost:8080/tickets/1"
                    //                             }
                    //                         }
                    //                     }],
                    //                     "_links": {
                    //                         "self": {
                    //                             "href": "http://localhost:8080/promotions/2"
                    //                         },
                    //                         "promotion": {
                    //                             "href": "http://localhost:8080/promotions/2"
                    //                         }
                    //                     }
                    //                 }
                    //             ]
                    //     },
                    //     "_links": {
                    //         "self": {
                    //             "href": "http://localhost:8080/promotions"
                    //         },
                    //         "profile": {
                    //             "href": "http://localhost:8080/profile/promotions"
                    //         }
                    //     }
                    // }
                </script>

</body>

</html>